# Kitten JWT

Keep It Simple, Stupid, Secure and Fast JWT module

Maintained by https://www.easilys.com and https://carbone.io

## Philosophy

- Keep it Simple Stupid
- Performance & Security focused
- Light, virtually no dependencies (except kitten-cache) : TODO

## Features

- Generate JWT
- Verify JWT
- Generate ECDH Public / Private keys
- Automatic JWT renewal every 12-hours : TODO
- LRU Cache mechanism : TODO
- Fastify, Restify or Express authentication middleware
- Highly secured by default with ECDH keys (secp521r1) : opinionated


## Installation

```js
  npm install kitten-jwt --save
```

## Getting started


* On client-side

```js
  var jwt = require('kitten-jwt');

  // Generate an ephemeral jwt token, auto-renewed every 12-hour by default
  // This function is very fast (uses lru-cache), it can be called for every HTTP request
  var header = jwt.generateAuto('client-id-1220202', 'server-app-name', 'privKeyOfTheClient');

  // Put the token in HTTP Header, it will be parsed by jwt.verifyHTTPHeaderFn automatically
  request.setHeader('Authorization', 'Bearer ' + header);

```

* On server-side 

```js
  var jwt = require('kitten-jwt');

  // custom method to get the client public key, kitten-jwt caches the result automatically
  function getPublicKeyFn(req, res, payload, callback) {
    var _clientId = payload.iss;
    // do whatever you want: db query, file read
    return callback('pubKeyOfTheClient');
  }

  // use the helper function to verify token in an express middleware
  // This function is very fast (uses lru-cache)
  express().use(jwt.verifyHTTPHeaderFn('server-app-name', getPublicKeyFn));

  // if the public key changes
  jwt.resetCache(clientId, (err) => {
    // cache invalidated
  });

  // In other middleware, you can print JWT payload object, added by verifyHTTPHeaderFn
  console.log(req.jwtPayload);
```


## API Usage

Token generated by kitten-jwt are quite compact for performance reasons, and follows JWT RFC

```js
  {
    iss  : clientId,                  // issuer
    aud  : serverId,                  // audience
    exp  : (Date.now() + expiresIn)   // expiration timestamp UTC
    data : data                       // optional
  }
```


### High-level API for Express-like applications

These functions uses cache to be as fast as possible

* `jwt.generateAuto (clientId, serverId, privKey, data)` : generate an ephemeral jwt token

  - clientId  : JWT issuer, token.iss
  - serverId  : JWT audience, token.aud
  - privKey   : private key
  - data      : accessible in token.data, optional

* `jwt.verifyHTTPHeaderFn (serverId, getPublicKeyFn)` : generate a function(req, req, next)

  - getPublicKeyFn    : Function(req, res, payload, callback) which returns publicKey in callback(pubKey)
  - serverId          : JWT audience, token.aud
  if the token is invalid, next(err) is called

* `jwt.resetCache (clientId, callback)` : invalidate cache


### Low-level API


* `jwt.generate (clientId, serverId, expiresIn, privKey, data)` : generate a token

  - clientId  : JWT issuer, token.iss
  - serverId  : JWT audience, token.aud
  - expiresIn : JWT duration in number of seconds
  - privKey   : private key
  - data      : accessible in token.data

  It returns a signed base64 url encoded string of the token.

* `jwt.verify (jwt, pubKey, callback)` : verify the signature of a token

  - jwt                     : JSON Web token string to verify
  - pubKey                  : public key
  - callback (err, payload) : callback, payload is an object

* `jwt.generateKeys (outputDir, outputKeyName)` : generate pub / priv ECDH keys

